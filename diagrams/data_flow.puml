@startuml DataFlow
!define LIGHTORANGE FFE0B2
!define LIGHTBLUE B3E5FC
!define LIGHTGREEN C8E6C9
!define LIGHTRED FFCDD2

skinparam arrowThickness 1.5
skinparam ArrowColor #333333
skinparam defaultFontSize 11

title Product Ingestion Data Flow with File Picker

|User|
start
:Click run_ingest_with_picker.bat;

|File Picker|
:Check Elasticsearch connection;

if (ES Running?) then (no)
  #LIGHTRED:Display error message\nâŒ Start Elasticsearch first\n./start_elasticsearch.bat;
  stop
else (yes)
  :âœ… Connection OK;
  :Open Windows dialog\nðŸ“‚ Select Products Excel;
  
  if (File selected?) then (yes)
    :Store products_path;
  else (no)
    #LIGHTRED:Exit with error\n(Products required);
    stop
  endif
  
  :Open dialog\nðŸ“‚ Select Orders CSV\n(optional);
  note right: User can click Cancel
  
  :Open dialog\nðŸ“‚ Select Returns CSV\n(optional);
  note right: User can click Cancel
endif

|Orchestrator|
:Log start message\nðŸš€ INGESTIE DATE;
:Pass file paths to\ningest modules;

|Product Ingestion|
:Load Excel with pandas\nro_column_map headers;
:Normalize columns:
â€¢ Cod â†’ sku
â€¢ Nume â†’ name
â€¢ Brand â†’ brand
â€¢ Pret â†’ price_final;

repeat
  :For each product row;
  
  |Attribute Extraction|
  :Apply regex patterns:
  â€¢ Volume: 30ml â†’ attr_volume_ml
  â€¢ Shade: #A021 â†’ attr_shade_code
  â€¢ Finish: mat â†’ attr_finish
  â€¢ Grit: 180/240 â†’ attr_grit
  â€¢ Material: inox â†’ attr_material
  â€¢ Collection: ColecÈ›ia X;
  
  if (Attributes found?) then (yes)
    :Merge attr_* fields\ninto document;
  else (no)
    :Keep base fields only;
  endif
  
  |Product Ingestion|
  :Add updated_at timestamp;
  :Buffer for bulk insert;
  
repeat while (More products?) is (yes)
->no;

:Bulk API call\n(batch size 500);

|Elasticsearch|
:Validate mapping\n(elastic_mappings.py);
:Index to products;
:Return success count;

|Product Ingestion|
:Log results\nâœ… 250 produse indexate;

if (Orders file provided?) then (yes)
  |Order Ingestion|
  :Load orders CSV;
  :Aggregate by SKU + date;
  :Index to sku_daily_stats;
endif

if (Returns file provided?) then (yes)
  |Return Ingestion|
  :Load returns CSV;
  :Update sku_daily_stats\nwith return counts;
endif

|Orchestrator|
:Display completion\nâœ… INGESTIE COMPLETÄ‚;
stop

@enduml
